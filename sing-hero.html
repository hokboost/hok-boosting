<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Karaoke Pitch Match - Hero</title>
  <script src="https://cdn.jsdelivr.net/npm/ml5@0.12.2/dist/ml5.min.js"></script>
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 60px;
    }
    h1 { color: #f0c040; }
    .lyric-line { font-size: 2em; margin-top: 30px; color: #f0f0f0; }
    .note-target, .note-detect { font-size: 1.2em; margin: 10px 0; }
    .match { color: #4caf50; }
    .no-match { color: #e53935; }
    button {
      padding: 12px 24px;
      font-size: 18px;
      background: #f0c040;
      color: #111;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 30px;
    }
  </style>
</head>
<body>

<h1>üé§ Sing "Hero" ‚Äì Match the Notes</h1>
<p class="lyric-line" id="lyric">Press Start to Begin</p>
<p class="note-target" id="targetNote"></p>
<p class="note-detect" id="detectedNote">üéµ Waiting...</p>
<button onclick="start()">Start Singing</button>

<script>
let pitch;
let audioContext;
let micStream;
let currentIndex = 0;

const lyrics = [
  { text: "‰Ω†", note: "F4" },
  { text: "ÁÇπ", note: "F4" },
  { text: "‰∫Æ", note: "F4" },
  { text: "Â§ö", note: "F4" },
  { text: "Â∞ë", note: "E4" },
  { text: "Èúì", note: "D4" },
  { text: "Ëôπ", note: "C#4" },
  { text: "ÂúÜ", note: "C#4" },
  { text: "Êª°", note: "C#4" },
  { text: "‰∫Ü", note: "C#4" },
  { text: "Ë∞Å", note: "C#4" },
  { text: "ÁöÑ", note: "D4" },
  { text: "Ê¢¶", note: "E4" },
];

function frequencyToNote(freq) {
  const A4 = 440;
  const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
  const n = Math.round(12 * Math.log2(freq / A4)) + 57;
  const name = notes[n % 12];
  const octave = Math.floor(n / 12) - 1;
  return `${name}${octave}`;
}

function start() {
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    micStream = audioContext.createMediaStreamSource(stream);

    ml5.pitchDetection(
      'https://cdn.jsdelivr.net/gh/ml5js/ml5-data-and-models@main/models/pitch-detection/crepe/',
      audioContext,
      micStream,
      model => {
        pitch = model;console.log("üéØ Pitch model loaded!");

        showNextLine();
        detectPitch();
      }
    );
  }).catch(err => {
    alert("üé§ Mic access error: " + err.message);
    console.error(err);
  });
}

function showNextLine() {
  if (currentIndex >= lyrics.length) {
    document.getElementById("lyric").innerText = "‚úÖ Finished! Great job!";
    document.getElementById("targetNote").innerText = "";
    return;
  }

  const line = lyrics[currentIndex];
  document.getElementById("lyric").innerText = line.text;
  document.getElementById("targetNote").innerText = `üéØ Target Note: ${line.note}`;
}

function detectPitch() {
  if (!pitch) return;
 console.log("Listening for pitch...");
 pitch.getPitch((err, freq) => {
    if (freq) {
      const sungNote = frequencyToNote(freq);
      const targetNote = lyrics[currentIndex]?.note;

      if (sungNote === targetNote) {
        document.getElementById("detectedNote").innerHTML = `‚úÖ You sang: <span class="match">${sungNote}</span>`;
        currentIndex++;
        setTimeout(() => {
          showNextLine();
        }, 1200);
      } else {
        document.getElementById("detectedNote").innerHTML = `‚ùå You sang: <span class="no-match">${sungNote}</span>`;
      }
    } else {
      document.getElementById("detectedNote").innerText = `üé§ Listening...`;
    }
    requestAnimationFrame(detectPitch);
  });
}
</script>

</body>
</html>



